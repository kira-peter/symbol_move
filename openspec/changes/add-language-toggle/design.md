# Design: 语言切换功能

## Context
符动世界当前只支持中文界面,需要添加国际化支持以服务更广泛的用户群体。用户希望通过 `Ctrl+Space` 快捷键在中英文之间切换,并且系统应该记住用户的语言偏好。

涉及的利益相关方:
- 用户:希望使用母语或熟悉的语言使用软件
- 开发者:需要维护翻译内容,添加新特效时需要提供双语信息
- 项目:提升国际化程度,扩大用户群

## Goals / Non-Goals

### Goals
- 支持中英文两种语言的界面切换
- 提供简单直观的切换方式 (`Ctrl+Space`)
- 持久化保存用户的语言偏好
- 翻译所有用户可见的文本(标题、提示、特效名称、特效描述)
- 保持代码简洁,避免过度设计

### Non-Goals
- 不支持除中英文之外的其他语言(未来可扩展)
- 不实现复杂的国际化框架或本地化系统
- 特效运行时不支持语言切换(只在选择器界面)
- 不翻译特效内部的视觉内容(如字符、符号等)
- 不支持从系统环境变量自动检测语言

## Decisions

### 1. 语言管理架构
**决定**: 创建独立的 `pkg/i18n` 包管理语言状态和翻译

**原因**:
- 单一职责:语言管理逻辑集中在一个包中
- 易于测试和维护
- 可复用:其他模块可以轻松引用

**实现要点**:
```go
// 语言类型
type Language string

const (
    LanguageChinese Language = "zh"
    LanguageEnglish Language = "en"
)

// 全局语言管理器
type Manager struct {
    current Language
    configPath string
}
```

### 2. 翻译数据存储方式
**决定**: 在代码中使用 map 存储翻译,而不是外部文件

**原因**:
- 简单:只有两种语言,翻译量不大
- 编译时检查:避免运行时找不到翻译文件
- 性能:无需文件 I/O
- 部署方便:单一可执行文件

**备选方案**:
- 外部 JSON/YAML 文件:灵活但增加复杂度,对于两种语言过度设计
- gettext/i18n 库:功能强大但依赖重,不符合项目"轻量级"原则

**实现要点**:
```go
var uiTexts = map[Language]map[string]string{
    LanguageChinese: {
        "title": "符动世界(SymbolMove)",
        "subtitle": "字符符号在动,创造世界",
        // ...
    },
    LanguageEnglish: {
        "title": "SymbolMove",
        "subtitle": "Characters in Motion, Creating Worlds",
        // ...
    },
}
```

### 3. 特效元数据国际化
**决定**: 扩展 `effects.Metadata` 结构,添加 `NameEN` 和 `DescriptionEN` 字段

**原因**:
- 向后兼容:原有的 `Name` 和 `Description` 保持不变
- 简单直接:每个特效在注册时提供双语信息
- 类型安全:编译时检查,避免遗漏

**备选方案**:
- 使用 map 存储所有语言:更灵活但增加复杂度
- 使用接口方法 `GetName(lang Language)`:过度抽象

**实现要点**:
```go
type Metadata struct {
    ID              string
    Name            string   // 中文名称
    Description     string   // 中文描述
    NameEN          string   // 英文名称
    DescriptionEN   string   // 英文描述
    // ...
}
```

### 4. 配置持久化
**决定**: 使用 JSON 文件保存在 `~/.symbolmove/config.json`

**原因**:
- 标准位置:遵循用户目录配置文件惯例
- 易于扩展:未来可添加其他配置项
- 人类可读:用户可以手动编辑
- Go 标准库支持:无需额外依赖

**配置文件结构**:
```json
{
  "language": "zh",
  "version": "1.0"
}
```

### 5. 快捷键选择
**决定**: 使用 `Ctrl+Space` 作为语言切换快捷键

**原因**:
- 符合用户需求
- 输入法切换的通用习惯(许多系统使用此快捷键)
- 不与现有快捷键冲突(↑↓←→, Enter, q, Ctrl+C, ESC, 1-9/0)
- 单手操作方便

## Risks / Trade-offs

### Risk 1: 翻译质量和一致性
**风险**: 英文翻译可能不够地道或专业

**缓解措施**:
- 优先翻译核心界面文本,特效名称和描述可以简单直译
- 在 tasks.md 中列出所有需要翻译的特效,逐个审核
- 未来可以接受社区贡献改进翻译

### Risk 2: 维护负担
**风险**: 每次添加新特效都需要提供双语信息,可能被遗忘

**缓解措施**:
- 在特效模板中明确要求提供英文字段
- 如果缺少英文字段,可以回退到中文(优雅降级)
- 添加测试检查所有特效是否提供了英文翻译

### Risk 3: 配置文件损坏
**风险**: 配置文件可能被用户误删除或损坏

**缓解措施**:
- 配置文件不存在时,使用默认语言(中文)
- JSON 解析失败时,忽略错误并使用默认值
- 不影响核心功能,只是语言偏好丢失

### Trade-off: 特效运行时不支持切换
**权衡**: 为了简化实现,特效运行时不支持语言切换

**理由**:
- 大多数特效是视觉效果,没有文本显示
- 特效运行时切换需要重新初始化,增加复杂度
- 用户可以返回选择器界面切换语言后再进入特效
- 如果未来有需求,可以作为独立变更添加

## Migration Plan

### 阶段 1: 基础设施(不影响现有功能)
1. 实现 `pkg/i18n` 包
2. 添加配置文件读写逻辑
3. 编写单元测试

### 阶段 2: 界面集成
1. 扩展 `effects.Metadata` 结构
2. 修改选择器界面支持翻译
3. 测试界面切换

### 阶段 3: 特效翻译
1. 逐个更新特效元数据,添加英文字段
2. 可以分批完成,不需要一次性全部翻译
3. 未翻译的特效显示中文(优雅降级)

### 阶段 4: 主程序集成
1. 修改主程序初始化语言系统
2. 集成测试

### 回滚计划
如果出现问题,可以轻松回滚:
- 移除 `pkg/i18n` 包
- 恢复 `Selector` 的原始实现
- 删除 `effects.Metadata` 中的英文字段
- 对现有功能没有破坏性影响

## Open Questions

1. ~~是否需要在特效运行时也支持语言切换?~~
   → 已确定:仅在选择器界面支持

2. ~~语言偏好是否需要持久化?~~
   → 已确定:需要持久化到配置文件

3. ~~翻译范围是否包括特效名称和描述?~~
   → 已确定:包括所有界面文本

4. 是否需要为配置文件提供命令行参数指定路径?
   → 暂不需要,使用默认位置即可,未来可扩展
